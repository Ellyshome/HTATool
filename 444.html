<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel å­—ä½“é¢œè‰²è¯»å–å·¥å…·ï¼ˆéªŒè¯ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: #2c3e50;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #2980b9;
            background-color: #f8f9fa;
        }
        .upload-area input {
            display: none;
        }
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }
        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .verify-section {
            text-align: center;
            margin: 2rem 0;
            padding: 1rem;
            background-color: #f5fafe;
            border-radius: 8px;
        }
        .verify-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        .input-group {
            margin: 0 1rem;
        }
        .input-group input {
            padding: 0.5rem;
            width: 100px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        .result-area {
            margin-top: 2rem;
        }
        .result-title {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.8rem;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .color-box {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
            font-style: italic;
        }
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #e74c3c;
            border-radius: 4px;
        }
        .success-message {
            color: #27ae60;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #27ae60;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Excel å­—ä½“é¢œè‰²è¯»å–éªŒè¯å·¥å…·</h1>
        <p>æ ¸å¿ƒåŠŸèƒ½ï¼šè¯»å–ç‰¹å®šå•å…ƒæ ¼å­—ä½“é¢œè‰²å¹¶æ‰“å°åˆ°æ§åˆ¶å°ï¼ˆæŒ‰ F12 æŸ¥çœ‹ï¼‰</p>
    </div>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept=".xlsx" />
        <div class="upload-icon">ğŸ“¤</div>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ Excel æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h3>
        <p>ä»…æ”¯æŒ .xlsx æ ¼å¼ï¼ˆä¸æ”¯æŒ .xls æ—§æ ¼å¼ï¼‰</p>
        <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
    </div>

    <!-- éªŒè¯åŒºåŸŸï¼šæŒ‡å®šå•å…ƒæ ¼è¯»å–é¢œè‰² -->
    <div class="verify-section" id="verifySection" style="display: none;">
        <h3>éªŒè¯ç‰¹å®šå•å…ƒæ ¼å­—ä½“é¢œè‰²</h3>
        <div class="input-group">
            <input type="text" id="cellAddress" placeholder="è¾“å…¥å•å…ƒæ ¼ï¼ˆå¦‚ A1ï¼‰" value="A1" />
            <button class="btn" id="verifyBtn">è¯»å–å¹¶æ‰“å°åˆ°æ§åˆ¶å°</button>
        </div>
        <p style="margin-top: 0.5rem; color: #7f8c8d;">
            æç¤ºï¼šæŒ‰ F12 æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œç‚¹å‡»æŒ‰é’®åæŸ¥çœ‹é¢œè‰²æ•°æ®
        </p>
    </div>

    <!-- æç¤ºåŒºåŸŸ -->
    <div class="success-message" id="successMessage" style="display: none;"></div>
    <div class="error-message" id="errorMessage" style="display: none;"></div>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div class="result-area" id="resultArea" style="display: none;">
        <div class="result-title">
            <span id="fileName">æ–‡ä»¶ï¼šæœªé€‰æ‹©æ–‡ä»¶</span>
            <button class="btn" style="margin-left: 1rem;" id="clearBtn">æ¸…ç©ºç»“æœ</button>
        </div>
        <div class="table-container">
            <table id="resultTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ç¨³å®šçš„ ExcelJS CDNï¼ˆunpkgï¼‰ -->
    <script src="https://unpkg.com/exceljs@4.4.0/dist/exceljs.min.js"></script>

    <script>
        // å…¨å±€å˜é‡ï¼šå­˜å‚¨è§£æåçš„å·¥ä½œç°¿å’Œå·¥ä½œè¡¨ï¼ˆä¾›éªŒè¯åŠŸèƒ½ä½¿ç”¨ï¼‰
        let globalWorksheet = null;
        let globalWorkbook = null;

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const verifySection = document.getElementById('verifySection');
        const cellAddress = document.getElementById('cellAddress');
        const verifyBtn = document.getElementById('verifyBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const resultArea = document.getElementById('resultArea');
        const fileName = document.getElementById('fileName');
        const resultTable = document.getElementById('resultTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const clearBtn = document.getElementById('clearBtn');

        // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#2980b9';
            uploadArea.style.backgroundColor = '#e3f2fd';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.backgroundColor = 'transparent';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.backgroundColor = 'transparent';
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                handleFileUpload(file);
            }
        });

        // æ–‡ä»¶é€‰æ‹©å˜åŒ–
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                handleFileUpload(file);
            }
        });

        // æ¸…ç©ºç»“æœ
        clearBtn.addEventListener('click', () => {
            resultArea.style.display = 'none';
            verifySection.style.display = 'none';
            successMessage.style.display = 'none';
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            fileInput.value = '';
            errorMessage.style.display = 'none';
            globalWorksheet = null;
            globalWorkbook = null;
        });

        // æ ¸å¿ƒéªŒè¯åŠŸèƒ½ï¼šè¯»å–æŒ‡å®šå•å…ƒæ ¼é¢œè‰²å¹¶æ‰“å°åˆ°æ§åˆ¶å°
        verifyBtn.addEventListener('click', () => {
            if (!globalWorksheet) {
                showError('è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶ï¼');
                return;
            }

            const address = cellAddress.value.trim().toUpperCase();
            if (!/^[A-Z]+\d+$/.test(address)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å•å…ƒæ ¼åœ°å€ï¼ˆå¦‚ A1ã€B2ã€C10ï¼‰');
                return;
            }

            try {
                // 1. è¯»å–æŒ‡å®šå•å…ƒæ ¼
                const cell = globalWorksheet.getCell(address);
                // 2. è·å–å­—ä½“é¢œè‰²ï¼ˆåŸå§‹æ•°æ® + æ ¼å¼åŒ– RGBï¼‰
                const rawColor = cell.font?.color || null;
                const formattedRgb = getFontColor(cell);

                // 3. æ‰“å°åˆ°æ§åˆ¶å°ï¼ˆæ ¸å¿ƒéªŒè¯æ­¥éª¤ï¼‰
                console.log('=====================================');
                console.log(`å•å…ƒæ ¼ ${address} å­—ä½“é¢œè‰²éªŒè¯ç»“æœï¼š`);
                console.log(`åŸå§‹é¢œè‰²æ•°æ®ï¼ˆExcelJS åŸç”Ÿè¿”å›ï¼‰ï¼š`, rawColor);
                console.log(`æ ¼å¼åŒ–å RGB é¢œè‰²ï¼š`, formattedRgb);
                console.log(`å•å…ƒæ ¼å€¼ï¼š`, cell.value);
                console.log('=====================================');

                // 4. é¡µé¢æç¤º
                showSuccess(`å·²è¯»å–å•å…ƒæ ¼ ${address} é¢œè‰²ï¼Œè¯·åˆ°æ§åˆ¶å°æŸ¥çœ‹è¯¦æƒ…ï¼`);
            } catch (err) {
                console.error(`è¯»å–å•å…ƒæ ¼ ${address} å¤±è´¥ï¼š`, err);
                showError(`è¯»å–å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        });

        /**
         * å¤„ç†æ–‡ä»¶ä¸Šä¼ é€»è¾‘
         * @param {File} file - ä¸Šä¼ çš„ Excel æ–‡ä»¶
         */
        async function handleFileUpload(file) {
            // éªŒè¯æ–‡ä»¶æ ¼å¼
            if (!file.name.endsWith('.xlsx')) {
                showError('è¯·ä¸Šä¼  .xlsx æ ¼å¼çš„ Excel æ–‡ä»¶ï¼Œä¸æ”¯æŒ .xls æ—§æ ¼å¼ï¼');
                return;
            }

            try {
                // éšè—é”™è¯¯æç¤ºï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                errorMessage.style.display = 'none';
                uploadArea.innerHTML = '<div class="upload-icon">â³</div><h3>æ­£åœ¨è¯»å–æ–‡ä»¶...</h3>';

                // è¯»å–æ–‡ä»¶å¹¶è§£æ
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(await file.arrayBuffer());

                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼ˆå¦‚æœéœ€è¦æ”¯æŒå¤šå·¥ä½œè¡¨ï¼Œå¯æ‰©å±•é€‰æ‹©é€»è¾‘ï¼‰
                const worksheet = workbook.worksheets[0];
                if (!worksheet) {
                    showError('Excel æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å·¥ä½œè¡¨ï¼');
                    resetUploadArea();
                    return;
                }

                // å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›éªŒè¯åŠŸèƒ½ä½¿ç”¨
                globalWorkbook = workbook;
                globalWorksheet = worksheet;

                // è§£æå·¥ä½œè¡¨æ•°æ®å’Œæ ·å¼
                const { headers, rows } = parseWorksheet(worksheet);

                // æ˜¾ç¤ºç»“æœå’ŒéªŒè¯åŒºåŸŸ
                showResult(file.name, headers, rows);
                verifySection.style.display = 'block'; // æ˜¾ç¤ºéªŒè¯åŒºåŸŸ
                resetUploadArea();

                // æç¤ºç”¨æˆ·å¼€å§‹éªŒè¯
                showSuccess(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å¯åœ¨ä¸‹æ–¹è¾“å…¥å•å…ƒæ ¼åœ°å€ï¼ˆå¦‚ A1ï¼‰éªŒè¯å­—ä½“é¢œè‰²`);

            } catch (err) {
                console.error('è¯»å– Excel å¤±è´¥ï¼š', err);
                showError(`æ–‡ä»¶è¯»å–å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}`);
                resetUploadArea();
            }
        }

        /**
         * è§£æå·¥ä½œè¡¨æ•°æ®å’Œå­—ä½“é¢œè‰²
         * @param {ExcelJS.Worksheet} worksheet - Excel å·¥ä½œè¡¨å¯¹è±¡
         * @returns {Object} { headers: è¡¨å¤´æ•°ç»„, rows: è¡Œæ•°æ®ï¼ˆåŒ…å«å€¼å’Œå­—ä½“é¢œè‰²ï¼‰ }
         */
        function parseWorksheet(worksheet) {
            const headers = [];
            const rows = [];

            // æ‰‹åŠ¨è·å–æœ€å¤§è¡Œå’Œåˆ—ï¼ˆå…¼å®¹ ExcelJS 4.4.0ï¼‰
            let maxRow = 1;
            let maxCol = 1;
            worksheet.eachRow((row) => {
                if (row.number > maxRow) maxRow = row.number;
                row.eachCell((cell) => {
                    if (cell.column > maxCol) maxCol = cell.column;
                });
            });

            // è§£æè¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
            for (let col = 1; col <= maxCol; col++) {
                const cell = worksheet.getCell(1, col);
                headers.push({
                    value: cell.value || `åˆ—${col}`,
                    fontColor: getFontColor(cell)
                });
            }

            // è§£ææ•°æ®è¡Œ
            for (let row = 2; row <= maxRow; row++) {
                const rowData = [];
                for (let col = 1; col <= maxCol; col++) {
                    const cell = worksheet.getCell(row, col);
                    rowData.push({
                        value: formatCellValue(cell.value),
                        fontColor: getFontColor(cell)
                    });
                }
                rows.push(rowData);
            }

            return { headers, rows };
        }

        /**
         * æ ¼å¼åŒ–å•å…ƒæ ¼å€¼
         * @param {any} value - åŸå§‹å€¼
         * @returns {string} æ ¼å¼åŒ–åçš„å€¼
         */
        function formatCellValue(value) {
            if (value === null || value === undefined) return '';
            if (value instanceof Date) {
                return value.toLocaleDateString('zh-CN', { 
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
            if (typeof value === 'number') {
                return Number.isInteger(value) ? value.toString() : value.toFixed(2);
            }
            return value.toString();
        }

        /**
         * è·å–å•å…ƒæ ¼å­—ä½“é¢œè‰²ï¼ˆæ ¼å¼åŒ– RGBï¼‰
         * @param {ExcelJS.Cell} cell - å•å…ƒæ ¼å¯¹è±¡
         * @returns {string} RGB é¢œè‰²å­—ç¬¦ä¸²ï¼ˆå¦‚ #FF0000ï¼‰
         */
        function getFontColor(cell) {
            if (!cell.font || !cell.font.color) {
                return '#000000'; // é»˜è®¤é»‘è‰²
            }

            const color = cell.font.color;
            if (color.argb) {
                return `#${color.argb.slice(2)}`; // ARGB â†’ RGB
            } else if (color.rgb) {
                return `#${color.rgb}`;
            } else if (color.theme) {
                const themeColors = {
                    0: '#000000', 1: '#FFFFFF', 2: '#333333', 3: '#EEEEEE',
                    4: '#0066CC', 5: '#FF6600', 6: '#009900', 7: '#CC0000',
                    8: '#9900CC', 9: '#FFCC00'
                };
                return themeColors[color.theme] || '#000000';
            }
            return '#000000';
        }

        /**
         * æ˜¾ç¤ºç»“æœè¡¨æ ¼
         * @param {string} fileName - æ–‡ä»¶å
         * @param {Array} headers - è¡¨å¤´
         * @param {Array} rows - æ•°æ®è¡Œ
         */
        function showResult(fileName, headers, rows) {
            document.getElementById('fileName').textContent = `æ–‡ä»¶ï¼š${fileName}`;

            // æ¸²æŸ“è¡¨å¤´
            let headerHtml = '<tr>';
            headers.forEach(header => {
                headerHtml += `
                    <th style="color: ${header.fontColor};">
                        <span class="color-box" style="background-color: ${header.fontColor};"></span>
                        ${header.value}
                    </th>
                `;
            });
            headerHtml += '</tr>';
            tableHeader.innerHTML = headerHtml;

            // æ¸²æŸ“æ•°æ®è¡Œ
            let bodyHtml = '';
            if (rows.length === 0) {
                bodyHtml = `<tr><td colspan="${headers.length}" class="no-data">å·¥ä½œè¡¨ä¸­æ²¡æœ‰æ•°æ®è¡Œ</td></tr>`;
            } else {
                rows.forEach(row => {
                    bodyHtml += '<tr>';
                    row.forEach(cell => {
                        bodyHtml += `
                            <td style="color: ${cell.fontColor};">
                                <span class="color-box" style="background-color: ${cell.fontColor};"></span>
                                ${cell.value}
                            </td>
                        `;
                    });
                    bodyHtml += '</tr>';
                });
            }
            tableBody.innerHTML = bodyHtml;

            resultArea.style.display = 'block';
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸæç¤º
         * @param {string} message - æç¤ºä¿¡æ¯
         */
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤º
         * @param {string} message - é”™è¯¯ä¿¡æ¯
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        /**
         * é‡ç½®ä¸Šä¼ åŒºåŸŸ
         */
        function resetUploadArea() {
            uploadArea.innerHTML = `
                <input type="file" id="fileInput" accept=".xlsx" />
                <div class="upload-icon">ğŸ“¤</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ Excel æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h3>
                <p>ä»…æ”¯æŒ .xlsx æ ¼å¼ï¼ˆä¸æ”¯æŒ .xls æ—§æ ¼å¼ï¼‰</p>
                <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
            `;
            document.getElementById('selectFileBtn').addEventListener('click', () => {
                fileInput.click();
            });
        }
    </script>
</body>
</html>