<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花卷子的排班工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c5364;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .upload-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .function-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .function-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .function-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .function-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 1.3rem;
            color: #2c5364;
            font-weight: bold;
        }

        .download-btn {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .table-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        th {
            background: #2c5364;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>花卷子的排班工具</h1>
            <p>基于JavaScript实现的医生排班处理工具</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                选择Excel文件
            </button>
            <p>或拖放文件到此区域</p>
            <div class="file-info" id="fileInfo">未选择文件</div>
        </div>

        <div class="function-section">
            <button class="function-btn" onclick="processFile('compare')" disabled id="compareBtn">
                对比表功能
            </button>
            <button class="function-btn" onclick="processFile('modifyTotal')" disabled id="modifyTotalBtn">
                改总表功能
            </button>
            <button class="function-btn" onclick="processFile('modifySheet')" disabled id="modifySheetBtn">
                改分表功能
            </button>
            <button class="function-btn" onclick="processFile('statistic')" disabled id="statisticBtn">
                主专统计功能
            </button>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <div class="result-title" id="resultTitle">处理结果</div>
                <button class="download-btn" onclick="downloadResult()" id="downloadBtn" style="display: none;">
                    下载结果
                </button>
            </div>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let currentWorkbook = null;
        let currentFileName = '';
        let resultData = null;
        let mergedCellsMap = new Map(); // 存储所有sheet的合并单元格信息

        // 修复1：医生类语法错误（≤ 改为 <=）+ 简化初始化，避免加载阻塞
        class Doctor {
            constructor(cell, sheetName, row) {
                this.cell = cell;
                this.name = this.extractName(cell.v);
                this.sheetName = sheetName;
                this.row = row;
                this.col = cell.c;
                this.isValid = this.validateName(); // 姓名有效性校验
            }

            // 提取姓名（简化逻辑，提高兼容性）
            extractName(value) {
                if (!value || typeof value !== 'string') return '';
                // 提取中文字符（优先）
                const chineseMatch = value.match(/[\u4e00-\u9fff]+/g);
                if (chineseMatch && chineseMatch.length > 0) {
                    return chineseMatch[0].trim();
                }
                // 提取英文/数字（备用）
                const engMatch = value.match(/[a-zA-Z0-9]+/g);
                return engMatch ? engMatch[0].trim() : '';
            }

            // 修复2：语法错误 ≤ → <=
            validateName() {
                return this.name.length > 0 && this.name.length <= 4 && !this.name.includes('皮');
            }
        }

        // 文件上传处理（保持不变）
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // 修复3：简化文件读取逻辑，去掉可能不兼容的 cellStyles: true，增加错误捕获
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('请选择Excel文件 (.xlsx 或 .xls)');
                return;
            }

            currentFileName = file.name;
            document.getElementById('fileInfo').textContent = `已选择: ${file.name}`;

            const reader = new FileReader();
            // 修复4：使用普通函数，避免 this 指向问题
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // 去掉 cellStyles: true，提高兼容性（部分Excel版本不支持）
                    currentWorkbook = XLSX.read(data, { type: 'array' });
                    // 简化合并单元格解析，避免加载时出错
                    parseAllMergedCells();
                    enableButtons();
                    showSuccess('文件加载成功！请选择要执行的功能。');
                } catch (error) {
                    // 详细错误提示，便于排查
                    showError(`文件读取失败: ${error.message}（请确认文件未损坏，且为标准Excel格式）`);
                    console.error('文件加载错误详情：', error);
                }
            };

            // 修复5：增加读取错误处理
            reader.onerror = function() {
                showError('文件读取失败：无法读取文件内容，请检查文件权限或重新选择文件');
            };

            reader.readAsArrayBuffer(file);
        }

        // 修复6：简化合并单元格解析逻辑，避免复杂计算导致的错误
        function parseAllMergedCells() {
            mergedCellsMap.clear();
            if (!currentWorkbook) return;

            currentWorkbook.SheetNames.forEach(sheetName => {
                const sheet = currentWorkbook.Sheets[sheetName];
                const mergedCells = sheet['!merges'] || [];
                const mergeInfoList = [];
                
                try {
                    mergedCells.forEach(merge => {
                        mergeInfoList.push({
                            minRow: merge.s.r,
                            maxRow: merge.e.r,
                            minCol: merge.s.c,
                            maxCol: merge.e.c,
                            masterAddr: XLSX.utils.encode_cell(merge.s)
                        });
                    });
                } catch (error) {
                    console.warn(`解析${sheetName}合并单元格失败，跳过：`, error);
                }
                
                mergedCellsMap.set(sheetName, mergeInfoList);
            });
        }

        // 修复7：简化主单元格获取逻辑，增加容错
        function getMasterCellAddr(sheetName, row, col) {
            try {
                const mergeInfoList = mergedCellsMap.get(sheetName) || [];
                for (const merge of mergeInfoList) {
                    if (row >= merge.minRow && row <= merge.maxRow && col >= merge.minCol && col <= merge.maxCol) {
                        return merge.masterAddr;
                    }
                }
            } catch (error) {
                console.warn('获取主单元格失败：', error);
            }
            return XLSX.utils.encode_cell({ r: row, c: col });
        }

        function enableButtons() {
            document.getElementById('compareBtn').disabled = false;
            document.getElementById('modifyTotalBtn').disabled = false;
            document.getElementById('modifySheetBtn').disabled = false;
            document.getElementById('statisticBtn').disabled = false;
        }

        // 获取医生列表（增加容错，避免因单个医生解析失败导致整体报错）
        function getDoctors(sheet, sheetName) {
            const doctors = [];
            if (!sheet || !sheet['!ref']) return doctors;

            try {
                const range = XLSX.utils.decode_range(sheet['!ref']);
                const baseRow = 2; // A3对应的row索引（0开始）

                for (let row = baseRow; row <= range.e.r; row++) {
                    const cellAddr = XLSX.utils.encode_cell({ r: row, c: 0 });
                    const cell = sheet[cellAddr];
                    if (cell && cell.v) {
                        try {
                            const doctor = new Doctor(cell, sheetName, row);
                            if (doctor.isValid) {
                                doctors.push(doctor);
                            }
                        } catch (error) {
                            console.warn(`解析医生失败（行${row+1}）：`, error);
                        }
                    }
                }
            } catch (error) {
                console.error(`获取${sheetName}医生列表失败：`, error);
                showError(`获取医生列表失败：${error.message}`);
            }

            return doctors;
        }

        // 医生模糊匹配（保持逻辑不变，增加容错）
        function fuzzyMatchDoctors(sourceDoctors, targetDoctors) {
            const matchedPairs = [];
            const matchedTargetIds = new Set();

            try {
                for (const sourceDoc of sourceDoctors) {
                    // 优先精确匹配
                    const exactMatch = targetDoctors.find(
                        targetDoc => targetDoc.name === sourceDoc.name && !matchedTargetIds.has(targetDoc.name)
                    );
                    if (exactMatch) {
                        matchedPairs.push({ source: sourceDoc, target: exactMatch });
                        matchedTargetIds.add(exactMatch.name);
                        continue;
                    }

                    // 模糊匹配（包含关系）
                    const fuzzyMatch = targetDoctors.find(
                        targetDoc => (sourceDoc.name.includes(targetDoc.name) || targetDoc.name.includes(sourceDoc.name)) && 
                                    !matchedTargetIds.has(targetDoc.name)
                    );
                    if (fuzzyMatch) {
                        matchedPairs.push({ source: sourceDoc, target: fuzzyMatch });
                        matchedTargetIds.add(fuzzyMatch.name);
                    }
                }
            } catch (error) {
                console.error('医生匹配失败：', error);
                showError(`医生匹配失败：${error.message}`);
            }

            return matchedPairs;
        }

        // 单元格值标准化（保持逻辑不变）
        function normalizeCellValue(value) {
            if (!value) return '';
            return String(value)
                .trim()
                .replace(/\s+/g, '') // 去除所有空格
                .replace(/[^\u4e00-\u9fff_a-zA-Z0-9]/g, '') // 保留中文、字母、数字、下划线
                .toLowerCase(); // 小写化
        }

        // 处理带"/"的单元格（保持逻辑不变）
        function splitSlashValue(value) {
            if (!value || typeof value !== 'string') return { am: '', pm: '' };
            if (value.includes('/')) {
                const [am, pm] = value.split('/').map(v => normalizeCellValue(v));
                return { am: am || '', pm: pm || '' };
            }
            return { am: normalizeCellValue(value), pm: '' };
        }

        // 对比表功能（保持逻辑不变，增加容错）
        function compareSheets() {
            const differences = [];
            try {
                if (currentWorkbook.SheetNames.length < 2) {
                    throw new Error('Excel文件需要包含至少2个工作表（1个总表+1个分表）');
                }

                const totalSheetName = currentWorkbook.SheetNames[0]; // 总表（第一个sheet）
                const totalSheet = currentWorkbook.Sheets[totalSheetName];
                const totalDoctors = getDoctors(totalSheet, totalSheetName); // 总表医生列表

                if (totalDoctors.length === 0) {
                    throw new Error(`总表${totalSheetName}未找到有效医生，请检查A列医生姓名格式`);
                }

                // 遍历所有分表（从第二个sheet开始）
                for (let i = 1; i < currentWorkbook.SheetNames.length; i++) {
                    const sheetName = currentWorkbook.SheetNames[i];
                    const sheet = currentWorkbook.Sheets[sheetName];
                    const sheetDoctors = getDoctors(sheet, sheetName); // 分表医生列表

                    if (sheetDoctors.length === 0) {
                        console.warn(`分表${sheetName}未找到有效医生，跳过对比`);
                        continue;
                    }

                    // 医生匹配（模糊匹配）
                    const matchedPairs = fuzzyMatchDoctors(sheetDoctors, totalDoctors);

                    if (matchedPairs.length === 0) {
                        console.warn(`分表${sheetName}未匹配到任何总表医生，跳过对比`);
                        continue;
                    }

                    // 对比14天排班（每天对应2列：上午/下午）
                    for (const pair of matchedPairs) {
                        const sourceDoc = pair.source; // 分表医生
                        const targetDoc = pair.target; // 总表医生

                        // 遍历14天（每天2列：上午=day+2，下午=day+3）
                        for (let day = 1; day <= 14; day++) {
                            const sheetAmCol = day + 2;
                            const sheetPmCol = day + 3;
                            const totalAmCol = day + 2;
                            const totalPmCol = day + 3;

                            // 上午对比
                            const sheetAmMasterAddr = getMasterCellAddr(sheetName, sourceDoc.row, sheetAmCol);
                            const sheetAmCell = sheet[sheetAmMasterAddr];
                            const sheetAmValue = sheetAmCell ? sheetAmCell.v : '';
                            const { am: sheetAmNorm } = splitSlashValue(sheetAmValue);

                            const totalAmMasterAddr = getMasterCellAddr(totalSheetName, targetDoc.row, totalAmCol);
                            const totalAmCell = totalSheet[totalAmMasterAddr];
                            const totalAmValue = totalAmCell ? totalAmCell.v : '';
                            const { am: totalAmNorm } = splitSlashValue(totalAmValue);

                            if (sheetAmNorm !== totalAmNorm) {
                                differences.push({
                                    分表名称: sheetName,
                                    日期: `第${day}天（上午）`,
                                    医生姓名: sourceDoc.name,
                                    总表排班: totalAmValue || '空',
                                    分表排班: sheetAmValue || '空',
                                    标准化对比: `总表="${totalAmNorm}" vs 分表="${sheetAmNorm}"`,
                                    差异状态: sheetAmNorm && totalAmNorm ? '内容不一致' : 
                                              sheetAmNorm ? '仅分表有排班' : '仅总表有排班'
                                });
                            }

                            // 下午对比
                            const sheetPmMasterAddr = getMasterCellAddr(sheetName, sourceDoc.row, sheetPmCol);
                            const sheetPmCell = sheet[sheetPmMasterAddr];
                            const sheetPmValue = sheetPmCell ? sheetPmCell.v : '';
                            const { am: sheetPmNorm } = splitSlashValue(sheetPmValue);

                            const totalPmMasterAddr = getMasterCellAddr(totalSheetName, targetDoc.row, totalPmCol);
                            const totalPmCell = totalSheet[totalPmMasterAddr];
                            const totalPmValue = totalPmCell ? totalPmCell.v : '';
                            const { am: totalPmNorm } = splitSlashValue(totalPmValue);

                            if (sheetPmNorm !== totalPmNorm) {
                                differences.push({
                                    分表名称: sheetName,
                                    日期: `第${day}天（下午）`,
                                    医生姓名: sourceDoc.name,
                                    总表排班: totalPmValue || '空',
                                    分表排班: sheetPmValue || '空',
                                    标准化对比: `总表="${totalPmNorm}" vs 分表="${sheetPmNorm}"`,
                                    差异状态: sheetPmNorm && totalPmNorm ? '内容不一致' : 
                                              sheetPmNorm ? '仅分表有排班' : '仅总表有排班'
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('对比表功能失败：', error);
                throw error;
            }

            if (differences.length === 0) {
                return {
                    type: 'compare',
                    data: [],
                    title: '排班对比结果',
                    message: '所有分表与总表排班完全一致，无差异'
                };
            }

            return {
                type: 'compare',
                data: differences,
                title: '排班对比结果'
            };
        }

        // 改总表功能（保持逻辑不变）
        function modifyTotalSheet() {
            const modifications = [];
            try {
                if (currentWorkbook.SheetNames.length < 2) {
                    throw new Error('Excel文件需要包含至少2个工作表（1个总表+1个分表）');
                }

                const totalSheetName = currentWorkbook.SheetNames[0];
                const totalSheet = currentWorkbook.Sheets[totalSheetName];
                const totalDoctors = getDoctors(totalSheet, totalSheetName);

                if (totalDoctors.length === 0) {
                    throw new Error(`总表${totalSheetName}未找到有效医生`);
                }

                for (let i = 1; i < currentWorkbook.SheetNames.length; i++) {
                    const sheetName = currentWorkbook.SheetNames[i];
                    const sheet = currentWorkbook.Sheets[sheetName];
                    const sheetDoctors = getDoctors(sheet, sheetName);
                    const matchedPairs = fuzzyMatchDoctors(sheetDoctors, totalDoctors);

                    for (const pair of matchedPairs) {
                        const sourceDoc = pair.source;
                        const targetDoc = pair.target;

                        for (let day = 1; day <= 14; day++) {
                            const amCol = day + 2;
                            const pmCol = day + 3;

                            // 上午单元格更新
                            const sourceAmAddr = getMasterCellAddr(sheetName, sourceDoc.row, amCol);
                            const targetAmAddr = getMasterCellAddr(totalSheetName, targetDoc.row, amCol);
                            const sourceAmCell = sheet[sourceAmAddr];
                            const targetAmCell = totalSheet[targetAmAddr];

                            const sourceAmValue = sourceAmCell ? sourceAmCell.v : '';
                            const targetAmValue = targetAmCell ? targetAmCell.v : '';

                            if (normalizeCellValue(sourceAmValue) !== normalizeCellValue(targetAmValue)) {
                                modifications.push({
                                    分表来源: sheetName,
                                    医生: sourceDoc.name,
                                    日期时段: `第${day}天（上午）`,
                                    原总表值: targetAmValue || '空',
                                    新总表值: sourceAmValue || '空'
                                });
                                if (sourceAmCell) {
                                    totalSheet[targetAmAddr] = { ...sourceAmCell };
                                } else {
                                    delete totalSheet[targetAmAddr];
                                }
                            }

                            // 下午单元格更新
                            const sourcePmAddr = getMasterCellAddr(sheetName, sourceDoc.row, pmCol);
                            const targetPmAddr = getMasterCellAddr(totalSheetName, targetDoc.row, pmCol);
                            const sourcePmCell = sheet[sourcePmAddr];
                            const targetPmCell = totalSheet[targetPmAddr];

                            const sourcePmValue = sourcePmCell ? sourcePmCell.v : '';
                            const targetPmValue = targetPmCell ? targetPmCell.v : '';

                            if (normalizeCellValue(sourcePmValue) !== normalizeCellValue(targetPmValue)) {
                                modifications.push({
                                    分表来源: sheetName,
                                    医生: sourceDoc.name,
                                    日期时段: `第${day}天（下午）`,
                                    原总表值: targetPmValue || '空',
                                    新总表值: sourcePmValue || '空'
                                });
                                if (sourcePmCell) {
                                    totalSheet[targetPmAddr] = { ...sourcePmCell };
                                } else {
                                    delete totalSheet[targetPmAddr];
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('改总表功能失败：', error);
                throw error;
            }

            return {
                type: 'modifyTotal',
                data: modifications,
                title: '总表修改结果',
                modifiedWorkbook: currentWorkbook
            };
        }

        // 改分表功能（保持逻辑不变）
        function modifySheet() {
            const modifications = [];
            try {
                if (currentWorkbook.SheetNames.length < 2) {
                    throw new Error('Excel文件需要包含至少2个工作表（1个总表+1个分表）');
                }

                const totalSheetName = currentWorkbook.SheetNames[0];
                const totalSheet = currentWorkbook.Sheets[totalSheetName];
                const totalDoctors = getDoctors(totalSheet, totalSheetName);

                if (totalDoctors.length === 0) {
                    throw new Error(`总表${totalSheetName}未找到有效医生`);
                }

                for (let i = 1; i < currentWorkbook.SheetNames.length; i++) {
                    const sheetName = currentWorkbook.SheetNames[i];
                    const sheet = currentWorkbook.Sheets[sheetName];
                    const sheetDoctors = getDoctors(sheet, sheetName);
                    const matchedPairs = fuzzyMatchDoctors(totalDoctors, sheetDoctors);

                    for (const pair of matchedPairs) {
                        const sourceDoc = pair.source; // 总表医生
                        const targetDoc = pair.target; // 分表医生

                        for (let day = 1; day <= 14; day++) {
                            const amCol = day + 2;
                            const pmCol = day + 3;

                            // 上午单元格更新
                            const sourceAmAddr = getMasterCellAddr(totalSheetName, sourceDoc.row, amCol);
                            const targetAmAddr = getMasterCellAddr(sheetName, targetDoc.row, amCol);
                            const sourceAmCell = totalSheet[sourceAmAddr];
                            const targetAmCell = sheet[targetAmAddr];

                            const sourceAmValue = sourceAmCell ? sourceAmCell.v : '';
                            const targetAmValue = targetAmCell ? targetAmCell.v : '';

                            if (normalizeCellValue(sourceAmValue) !== normalizeCellValue(targetAmValue)) {
                                modifications.push({
                                    分表名称: sheetName,
                                    医生: targetDoc.name,
                                    日期时段: `第${day}天（上午）`,
                                    原分表值: targetAmValue || '空',
                                    新分表值: sourceAmValue || '空'
                                });
                                if (sourceAmCell) {
                                    sheet[targetAmAddr] = { ...sourceAmCell };
                                } else {
                                    delete sheet[targetAmAddr];
                                }
                            }

                            // 下午单元格更新
                            const sourcePmAddr = getMasterCellAddr(totalSheetName, sourceDoc.row, pmCol);
                            const targetPmAddr = getMasterCellAddr(sheetName, targetDoc.row, pmCol);
                            const sourcePmCell = totalSheet[sourcePmAddr];
                            const targetPmCell = sheet[targetPmAddr];

                            const sourcePmValue = sourcePmCell ? sourcePmCell.v : '';
                            const targetPmValue = targetPmCell ? targetPmCell.v : '';

                            if (normalizeCellValue(sourcePmValue) !== normalizeCellValue(targetPmValue)) {
                                modifications.push({
                                    分表名称: sheetName,
                                    医生: targetDoc.name,
                                    日期时段: `第${day}天（下午）`,
                                    原分表值: targetPmValue || '空',
                                    新分表值: sourcePmValue || '空'
                                });
                                if (sourcePmCell) {
                                    sheet[targetPmAddr] = { ...sourcePmCell };
                                } else {
                                    delete sheet[targetPmAddr];
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('改分表功能失败：', error);
                throw error;
            }

            return {
                type: 'modifySheet',
                data: modifications,
                title: '分表修改结果',
                modifiedWorkbook: currentWorkbook
            };
        }

        // 主专统计功能（保持逻辑不变）
        function statisticAnalysis() {
            const statistics = [];
            try {
                if (currentWorkbook.SheetNames.length < 1) {
                    throw new Error('Excel文件需要包含至少1个工作表');
                }

                const sheetName = currentWorkbook.SheetNames[0];
                const sheet = currentWorkbook.Sheets[sheetName];
                const doctors = getDoctors(sheet, sheetName);
                const filterWords = ['激', '脱', '性', '靶', '注射', '美容', '带疱'];

                if (doctors.length === 0) {
                    throw new Error(`表${sheetName}未找到有效医生`);
                }

                for (let day = 1; day <= 14; day++) {
                    const amCol = day + 2;
                    const pmCol = day + 3;
                    const dayStats = {
                        日期: `第${day}天`,
                        上午主班: [],
                        上午专班: [],
                        下午主班: [],
                        下午专班: [],
                        全天主班总人数: 0,
                        全天专班总人数: 0
                    };

                    for (const doctor of doctors) {
                        // 上午统计
                        const amMasterAddr = getMasterCellAddr(sheetName, doctor.row, amCol);
                        const amCell = sheet[amMasterAddr];
                        const amValue = amCell ? String(amCell.v).trim() : '';

                        if (amValue && !filterWords.some(word => amValue.includes(word))) {
                            if (amValue.includes('主') || amValue.includes('甲病') || amValue.includes('黄褐斑') || amValue.includes('白癜风') || amValue.includes('痤疮')) {
                                dayStats.上午主班.push(doctor.name);
                            }
                            if (amValue.includes('专')) {
                                dayStats.上午专班.push(doctor.name);
                            }
                        }

                        // 下午统计
                        const pmMasterAddr = getMasterCellAddr(sheetName, doctor.row, pmCol);
                        const pmCell = sheet[pmMasterAddr];
                        const pmValue = pmCell ? String(pmCell.v).trim() : '';

                        if (pmValue && !filterWords.some(word => pmValue.includes(word))) {
                            if (pmValue.includes('主') || pmValue.includes('甲病') || pmValue.includes('黄褐斑') || pmValue.includes('白癜风') || pmValue.includes('痤疮')) {
                                dayStats.下午主班.push(doctor.name);
                            }
                            if (pmValue.includes('专')) {
                                dayStats.下午专班.push(doctor.name);
                            }
                        }
                    }

                    // 去重并计算总人数
                    const allMaster = [...new Set([...dayStats.上午主班, ...dayStats.下午主班])];
                    const allSpecial = [...new Set([...dayStats.上午专班, ...dayStats.下午专班])];
                    dayStats.全天主班总人数 = allMaster.length;
                    dayStats.全天专班总人数 = allSpecial.length;

                    // 格式化输出
                    dayStats.上午主班 = dayStats.上午主班.join('、') || '无';
                    dayStats.上午专班 = dayStats.上午专班.join('、') || '无';
                    dayStats.下午主班 = dayStats.下午主班.join('、') || '无';
                    dayStats.下午专班 = dayStats.下午专班.join('、') || '无';

                    statistics.push(dayStats);
                }
            } catch (error) {
                console.error('主专统计功能失败：', error);
                throw error;
            }

            return {
                type: 'statistic',
                data: statistics,
                title: '主班与专病门诊统计结果'
            };
        }

        // 处理文件功能入口（增加容错）
        function processFile(functionType) {
            if (!currentWorkbook) {
                showError('请先选择Excel文件');
                return;
            }

            showLoading('正在处理...');

            try {
                let result;
                switch (functionType) {
                    case 'compare':
                        result = compareSheets();
                        break;
                    case 'modifyTotal':
                        result = modifyTotalSheet();
                        break;
                    case 'modifySheet':
                        result = modifySheet();
                        break;
                    case 'statistic':
                        result = statisticAnalysis();
                        break;
                    default:
                        throw new Error('未知的功能类型');
                }

                displayResult(result, functionType);
            } catch (error) {
                showError('处理失败: ' + error.message);
            }
        }

        // 显示结果（保持不变）
        function displayResult(result, functionType) {
            resultData = result;
            const resultSection = document.getElementById('resultSection');
            const resultTitle = document.getElementById('resultTitle');
            const resultContent = document.getElementById('resultContent');
            const downloadBtn = document.getElementById('downloadBtn');

            resultTitle.textContent = result.title;
            resultSection.classList.add('active');

            if (result.data.length === 0) {
                resultContent.innerHTML = `<div class="success">${result.message || '未发现需要处理的数据'}</div>`;
                downloadBtn.style.display = 'none';
                return;
            }

            let html = '<div class="table-container"><table><thead><tr>';
            const headers = Object.keys(result.data[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            result.data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            resultContent.innerHTML = html;

            downloadBtn.style.display = (functionType === 'modifyTotal' || functionType === 'modifySheet') ? 'inline-block' : 'none';
        }

        // 下载结果（保持不变）
        function downloadResult() {
            if (!resultData || !resultData.modifiedWorkbook) {
                showError('没有可下载的修改结果');
                return;
            }

            try {
                const wb = resultData.modifiedWorkbook;
                XLSX.writeFile(wb, `修改后的_${currentFileName}`);
                showSuccess('文件下载成功！');
            } catch (error) {
                showError('下载失败: ' + error.message);
            }
        }

        // 工具函数（保持不变）
        function showLoading(message) {
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<div class="loading">${message}</div>`;
            document.getElementById('resultSection').classList.add('active');
        }

        function showError(message) {
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('resultSection').classList.add('active');
        }

        function showSuccess(message) {
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<div class="success">${message}</div>`;
            document.getElementById('resultSection').classList.add('active');
        }
    </script>
</body>
</html>