<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花卷子排班工具 (JS完整修复版)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c5364; font-size: 2.2rem; margin-bottom: 10px; }
        .header p { color: #666; }
        
        /* 上传区域 */
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .upload-section:hover, .upload-section.dragover { border-color: #007bff; background: #e7f3ff; }
        .upload-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white; border: none; padding: 12px 30px;
            border-radius: 25px; font-size: 1.1rem; cursor: pointer;
            transition: transform 0.2s; margin: 10px;
        }
        .upload-btn:hover { transform: translateY(-2px); }
        .file-info { margin-top: 15px; font-size: 0.9rem; color: #666; min-height: 20px;}

        /* 功能按钮区域 */
        .function-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .function-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white; border: none; padding: 15px;
            border-radius: 10px; font-size: 1rem; cursor: pointer;
            transition: transform 0.2s;
        }
        .function-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        .function-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; }

        /* 结果区域 */
        .result-section { display: none; background: #fff; border-top: 1px solid #eee; padding-top: 20px; }
        .result-section.active { display: block; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .download-btn {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529; border: none; padding: 8px 20px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
            display: none; /* 默认隐藏 */
        }
        
        .table-container { max-height: 400px; overflow: auto; border: 1px solid #dee2e6; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: center; border: 1px solid #dee2e6; white-space: nowrap; }
        th { background: #2c5364; color: white; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background: #f8f9fa; }
        
        /* 消息提示 */
        #messageArea { margin-top: 10px; }
        .error { color: #721c24; background: #f8d7da; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .loading { color: #004085; background: #cce5ff; padding: 10px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>花卷子排班工具 v3.0 (Web版)</h1>
            <p>完美还原Python逻辑 · 支持样式保留 · 自动合并单元格</p>
        </div>

        <div class="upload-section" id="drop-area">
            <button class="upload-btn" id="uploadBtn">选择排班Excel文件</button>
            <input type="file" id="fileInput" accept=".xlsx" hidden>
            <p>或将文件拖拽至此处</p>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="function-section">
            <button class="function-btn" id="compareBtn" disabled>0. 对比表</button>
            <button class="function-btn" id="modifyMasterBtn" disabled>1. 改总表 (分覆盖总)</button>
            <button class="function-btn" id="modifySubBtn" disabled>2. 改分表 (总覆盖分)</button>
            <button class="function-btn" id="statisticBtn" disabled>3. 主专统计</button>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <div class="result-title">处理结果</div>
                <button class="download-btn" id="downloadBtn">下载结果文件</button>
            </div>
            <div id="messageArea"></div>
            <div class="table-container">
                <table id="resultTable"></table>
            </div>
        </div>
    </div>

    <script>
        // --- 核心变量 ---
        let workbook = null;
        let fileName = '';
        
        // --- DOM 元素 ---
        const els = {
            uploadBtn: document.getElementById('uploadBtn'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            dropArea: document.getElementById('drop-area'),
            btns: {
                compare: document.getElementById('compareBtn'),
                modMaster: document.getElementById('modifyMasterBtn'),
                modSub: document.getElementById('modifySubBtn'),
                stat: document.getElementById('statisticBtn'),
                download: document.getElementById('downloadBtn')
            },
            resultSection: document.getElementById('resultSection'),
            table: document.getElementById('resultTable'),
            msg: document.getElementById('messageArea')
        };

        // --- 事件监听 ---
        els.uploadBtn.addEventListener('click', () => els.fileInput.click());
        els.fileInput.addEventListener('change', handleFileSelect);
        els.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); els.dropArea.classList.add('dragover'); });
        els.dropArea.addEventListener('drop', handleDrop);
        
        els.btns.compare.addEventListener('click', () => processWorkbook('compare'));
        els.btns.modMaster.addEventListener('click', () => processWorkbook('modifyMaster'));
        els.btns.modSub.addEventListener('click', () => processWorkbook('modifySub'));
        els.btns.stat.addEventListener('click', () => processWorkbook('statistic'));
        els.btns.download.addEventListener('click', downloadResult);

        // --- 核心逻辑类与函数 ---

        // 医生类 (还原 Python 逻辑)
        class Doctor {
            constructor(cell, sheetTitle, r, c) {
                this.cell = cell;
                this.section = sheetTitle;
                this.row = r;
                this.col = c;
                this.cell_t = null; // 总表中的匹配信息
                this.name = this.extractName(cell.v);
            }

            extractName(value) {
                value = String(value);
                let name = value;
                // 分离非中文 (Python: findall('[^\u4e00-\u9fff]'))
                const nonChinese = value.match(/[^\u4e00-\u9fff]/);
                if (nonChinese) {
                    name = value.split(nonChinese[0])[0];
                }
                
                if (name.length > 4 || name.includes('皮')) {
                    console.warn(`[${this.section}] 疑似非法姓名丢弃: ${name}`);
                    this.section = '错误';
                }
                return name;
            }
        }

        // 查找单元格 (还原 Python lookfor)
        function lookfor(sheet, name) {
            // Python代码是在 col=1 (B列) 查找
            const targetCol = 1; 
            const range = XLSX.utils.decode_range(sheet['!ref']);
            const matches = [];

            for (let r = 1; r <= range.e.r; r++) { // 从第2行开始 (row index 1)
                const cellAddr = XLSX.utils.encode_cell({r: r, c: targetCol});
                const cell = sheet[cellAddr];
                if (!cell || !cell.v) continue;

                const val = String(cell.v);
                // 过滤逻辑
                if (val.length > 18) continue;
                if (val.includes('皮') || val.length > 10) continue;

                if (val.includes(name)) {
                    matches.push({ r: r, c: targetCol, cell: cell });
                }
            }

            if (matches.length === 1) return matches[0];
            return null;
        }

        // 获取医生列表 (增加启发式过滤)
        function getDoctors(sheet) {
            const doctors = [];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            
            // 假设医生姓名在 A 列 (索引 0)
            for (let r = 0; r <= range.e.r; r++) {
                const cellAddr = XLSX.utils.encode_cell({r: r, c: 0});
                const cell = sheet[cellAddr];
                if (!cell || !cell.v) continue;
                
                const val = String(cell.v).trim();
                
                // 黑名单过滤 (防止把表头或备注当成医生)
                if (['备注', '总计', '日期', '姓名', '排班', '时间'].some(k => val.includes(k))) continue;
                if (val.length > 8) continue; // 名字过长通常不是名字

                doctors.push(new Doctor(cell, sheet.title, r, 0));
            }
            return doctors.filter(d => d.section !== '错误');
        }

        // 匹配医生
        function matchDoctors(doctors, masterSheet) {
            const matched = [];
            doctors.forEach(doc => {
                const found = lookfor(masterSheet, doc.name);
                if (found) {
                    doc.cell_t = found;
                    matched.push(doc);
                }
            });
            return matched;
        }

        // 同步合并单元格 (关键修复)
        function syncMerges(sourceSheet, targetSheet, sourceRow, targetRow, sourceColOffset, targetColOffset) {
            if (!sourceSheet['!merges']) return;
            if (!targetSheet['!merges']) targetSheet['!merges'] = [];

            // 找到源行所有的合并块
            const rowMerges = sourceSheet['!merges'].filter(m => m.s.r === sourceRow && m.e.r === sourceRow);

            rowMerges.forEach(merge => {
                // 计算该合并块相对于姓名列的偏移
                const startRel = merge.s.c - sourceColOffset;
                const endRel = merge.e.c - sourceColOffset;

                // 应用到目标行
                // 注意：这里为了安全，不执行复杂的 unmerge，而是追加新的 merge
                // 实际 Excel 打开时通常会以最后的 merge 为准或自动修复
                targetSheet['!merges'].push({
                    s: { r: targetRow, c: targetColOffset + startRel },
                    e: { r: targetRow, c: targetColOffset + endRel }
                });
            });
        }

        // 核心处理逻辑 (change_sheet_s)
        function changeSheetS(subSheet, masterSheet, flag) {
            // flag: 0=对比, 1=改总表, 2=改分表
            const doctors = getDoctors(subSheet);
            const matched = matchDoctors(doctors, masterSheet);
            const diffs = [];
            let modifiedCount = 0;

            matched.forEach(doc => {
                const masterInfo = doc.cell_t;
                // 确定姓名列索引
                const subNameCol = doc.col; 
                const masterNameCol = masterInfo.c;

                // 1. 同步合并单元格
                if (flag === 1) {
                    syncMerges(subSheet, masterSheet, doc.row, masterInfo.r, subNameCol, masterNameCol);
                } else if (flag === 2) {
                    syncMerges(masterSheet, subSheet, masterInfo.r, doc.row, masterNameCol, subNameCol);
                }

                // 2. 遍历 14 天排班
                for (let day = 1; day <= 14; day++) {
                    const subAddr = XLSX.utils.encode_cell({r: doc.row, c: subNameCol + day});
                    const masterAddr = XLSX.utils.encode_cell({r: masterInfo.r, c: masterNameCol + day});

                    let cellSub = subSheet[subAddr] || {v: null, s: {}};
                    let cellMaster = masterSheet[masterAddr] || {v: null, s: {}};

                    // 准备数据
                    const valSub = cleanValue(cellSub.v);
                    const valMaster = cleanValue(cellMaster.v);

                    if (flag === 0) {
                        // 对比模式
                        if (valSub !== valMaster) {
                            diffs.push({ name: doc.name, day: day, m: cellMaster.v||'空', s: cellSub.v||'空' });
                        }
                    } else {
                        // 修改模式
                        let src, tgt, tgtSheet, tgtAddr;
                        
                        if (flag === 1) { // 分 -> 总
                            src = cellSub; tgt = cellMaster; tgtSheet = masterSheet; tgtAddr = masterAddr;
                        } else { // 总 -> 分
                            src = cellMaster; tgt = cellSub; tgtSheet = subSheet; tgtAddr = subAddr;
                        }

                        // 执行复制 (值 + 样式)
                        if (!tgtSheet[tgtAddr]) tgtSheet[tgtAddr] = { t: 's', v: '' };
                        tgtSheet[tgtAddr].v = src.v;
                        // 深拷贝样式对象 (xlsx-js-style 特有)
                        if (src.s) {
                            tgtSheet[tgtAddr].s = JSON.parse(JSON.stringify(src.s));
                        }
                        modifiedCount++;
                    }
                }
            });

            return { diffs, modifiedCount };
        }

        // 辅助：清理值
        function cleanValue(v) {
            if (v === null || v === undefined) return '';
            return String(v).replace(/\s+/g, '').toLowerCase();
        }

        // 获取合并状态 (用于统计)
        function getMergeState(sheet, r, c) {
            if (!sheet['!merges']) return 0;
            for (let m of sheet['!merges']) {
                if (m.s.r <= r && r <= m.e.r && m.s.c <= c && c <= m.e.c) {
                    return (m.s.c === c && m.s.r === r) ? 1 : 2; // 简化判断：左上角为主
                }
            }
            return 0;
        }

        // --- 流程控制 ---

        async function processWorkbook(mode) {
            if (!workbook) return showMsg('请先加载文件', 'error');
            
            showMsg('正在处理...', 'loading');
            els.table.innerHTML = '';
            els.btns.download.style.display = 'none';

            // 给UI一点渲染时间
            setTimeout(() => {
                try {
                    const sheets = workbook.Sheets;
                    const masterSheet = sheets[workbook.SheetNames[0]];
                    
                    if (mode === 'compare') {
                        runCompare(sheets, masterSheet);
                    } else if (mode === 'modifyMaster') {
                        runModify(sheets, masterSheet, 1);
                    } else if (mode === 'modifySub') {
                        runModify(sheets, masterSheet, 2);
                    } else if (mode === 'statistic') {
                        runStatistic(masterSheet);
                    }
                } catch (e) {
                    console.error(e);
                    showMsg('运行出错: ' + e.message, 'error');
                }
            }, 100);
        }

        function runCompare(sheets, masterSheet) {
            let totalDiffs = 0;
            let html = '<thead><tr><th>姓名</th><th>天数</th><th>总表</th><th>分表</th></tr></thead><tbody>';
            
            for (let i = 1; i < workbook.SheetNames.length; i++) {
                const subSheet = sheets[workbook.SheetNames[i]];
                const res = changeSheetS(subSheet, masterSheet, 0);
                
                res.diffs.forEach(d => {
                    html += `<tr><td>${d.name}</td><td>第${d.day}天</td><td>${d.m}</td><td>${d.s}</td></tr>`;
                });
                totalDiffs += res.diffs.length;
            }
            html += '</tbody>';
            
            if (totalDiffs === 0) {
                showMsg('完美！未发现任何差异', 'success');
                els.table.innerHTML = '<tr><td colspan="4">无差异</td></tr>';
            } else {
                showMsg(`发现 ${totalDiffs} 处不一致`, 'error');
                els.table.innerHTML = html;
            }
        }

        function runModify(sheets, masterSheet, flag) {
            for (let i = 1; i < workbook.SheetNames.length; i++) {
                const subSheet = sheets[workbook.SheetNames[i]];
                changeSheetS(subSheet, masterSheet, flag);
            }
            const type = flag === 1 ? '总表' : '分表';
            showMsg(`${type}修改完成！样式与合并已同步，请下载保存。`, 'success');
            els.btns.download.style.display = 'block';
        }

        function runStatistic(sheet) {
            const stats = {};
            const range = XLSX.utils.decode_range(sheet['!ref']);
            
            // 过滤关键词 (Python原版)
            const exclude = ['激', '脱', '性', '靶', '注射', '美容', '带疱'];
            const include = ['主', '专', '甲病', '黄褐斑', '白癜风', '痤疮'];

            // 遍历列 (假设 3-16列 是排班)
            for (let c = 2; c <= 15; c++) {
                const day = c - 1;
                stats[day] = [];
                
                for (let r = 1; r <= range.e.r; r++) {
                    const cellAddr = XLSX.utils.encode_cell({r:r, c:c});
                    const cell = sheet[cellAddr];
                    if (!cell || !cell.v) continue;
                    
                    // 跳过非主合并单元格
                    if (getMergeState(sheet, r, c) === 2) continue;

                    const val = String(cell.v).trim();
                    if (val.length > 10) continue;
                    if (exclude.some(k => val.includes(k))) continue;
                    
                    if (include.some(k => val.includes(k))) {
                        stats[day].push(`${r+1}-${val}`);
                    }
                }
            }

            let html = '<thead><tr><th>天数</th><th>人数</th><th>详情</th></tr></thead><tbody>';
            for (let d in stats) {
                const count = stats[d].length;
                const bg = count > 16 ? 'style="background:#ffebee; color:#c62828; font-weight:bold;"' : '';
                html += `<tr ${bg}><td>第${d}天</td><td>${count}</td><td style="text-align:left">${stats[d].join(', ')}</td></tr>`;
            }
            html += '</tbody>';
            
            els.table.innerHTML = html;
            showMsg('统计完成 (红色行表示超过16人)', 'success');
        }

        // --- 文件操作 ---

        function handleFileSelect(e) {
            const file = e.target.files[0] || e.dataTransfer.files[0];
            if (!file || !file.name.endsWith('.xlsx')) return showMsg('请使用 .xlsx 文件', 'error');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                // 关键参数 cellStyles: true 用于读取样式
                workbook = XLSX.read(data, { type: 'array', cellStyles: true });
                fileName = file.name;
                
                els.fileInfo.textContent = `当前文件: ${file.name}`;
                els.fileInfo.style.color = 'green';
                showMsg('文件加载成功，请选择功能', 'success');
                
                // 启用按钮
                Object.values(els.btns).forEach(b => b.disabled = false);
                els.btns.download.style.display = 'none'; // 刚加载时不显示下载
            };
            reader.readAsArrayBuffer(file);
        }
        function handleDrop(e) {
            e.preventDefault(); els.dropArea.classList.remove('dragover');
            e.target.files = e.dataTransfer.files; // Hack to reuse handleFileSelect logic
            handleFileSelect(e);
        }

        function downloadResult() {
            if (!workbook) return;
            const ts = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const newName = fileName.replace('.xlsx', `_processed_${ts}.xlsx`);
            // 使用 xlsx-js-style 的写入方法
            XLSX.writeFile(workbook, newName, { cellStyles: true });
        }

        function showMsg(text, type) {
            els.msg.innerHTML = `<div class="${type}">${text}</div>`;
        }
    </script>
</body>
</html>